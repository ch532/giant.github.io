<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Autoplay VAST Ad</title>
  <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
  <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-ads@6.8.0/dist/videojs-contrib-ads.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ima@1.8.0/dist/videojs.ima.min.js"></script>
  <style>
    body {
      background: #000;
      margin: 0;
      padding: 20px;
    }
    .video-js {
      width: 100%;
      max-width: 640px;
      height: 360px;
      margin: auto;
      display: block;
    }
  </style>
</head>
<body>

  <video id="content_video" class="video-js vjs-default-skin" controls autoplay muted playsinline>
    <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4" />
  </video>

  <script>
  let retryCount = 0;

  function loadVAST() {
    if (retryCount > 2) {
      console.warn("No ads after 3 attempts.");
      document.getElementById("adContainer").innerHTML = "<p>No ad available</p>";
      return;
    }

    const player = document.createElement("video");
    player.setAttribute("id", "vastPlayer");
    player.setAttribute("width", "100%");
    player.setAttribute("height", "auto");
    player.setAttribute("autoplay", "");
    player.setAttribute("controls", "");

    const vastTag = "https://s.magsrv.com/v1/vast.php?idzone=5688604";

    const ima = new google.ima.AdsLoader(new google.ima.AdDisplayContainer(document.getElementById("adContainer")));
    const adsRequest = new google.ima.AdsRequest();
    adsRequest.adTagUrl = vastTag;

    ima.addEventListener(
      google.ima.AdErrorEvent.Type.AD_ERROR,
      function () {
        retryCount++;
        loadVAST(); // retry
      },
      false
    );

    ima.addEventListener(
      google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
      function (event) {
        const adsManager = event.getAdsManager(player);
        adsManager.init(640, 360, google.ima.ViewMode.NORMAL);
        adsManager.start();
      },
      false
    );

    ima.requestAds(adsRequest);
  }

  window.addEventListener("load", loadVAST);
</script>

<div id="adContainer"></div>

</body>
</html>
