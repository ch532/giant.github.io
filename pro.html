<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IQ Pro</title>
<script src="https://bridge.playgama.com/v1/stable/playgama-bridge.js"></script>
<style>
  :root{--bg:#000;--card:#1e1e1e;--accent:#0ea5a4;--muted:#999;}
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#fff}
  .wrap{max-width:640px;margin:20px auto;padding:16px}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.6)}
  h1{margin:6px 0 12px;font-size:22px}
  .row{display:flex;gap:8px;align-items:center}
  .spacer{flex:1}
  #level,#coins{font-weight:600}
  #question{margin:14px 0;font-size:18px;min-height:48px;color:#fff}
  .answers{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{background:#2a2a2a;border:0;padding:10px;border-radius:8px;color:#fff;font-size:15px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent)}
  #message{min-height:24px;color:#ffd54d;margin-top:10px}
  #timer{font-weight:600;margin:8px 0}
  .small{font-size:13px;color:var(--muted)}
  #controls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  #game-over{display:none;text-align:center;padding:12px}
  #hint{font-size:13px;color:#cfcfcf;margin-top:8px}
  .meter{height:8px;background:#2a2a2a;border-radius:8px;overflow:hidden}
  .meter > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#5eead4);width:0%}
  #lives{margin-top:8px}
  footer{margin-top:16px;text-align:center;color:var(--muted);font-size:13px}
  #iap-buttons{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}

  /* Splash overlay */
  #splash {
    position:fixed;
    inset:0;
    background:#000;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
    flex-direction:column;
    gap:18px;
  }
  #splash img{ width:140px; height:auto; display:block; }
  #splash h2{ margin:0; font-size:26px; color:#fff; font-weight:700; letter-spacing:0.5px;}
  /* instant (no fade) but feel free to tweak */
</style>
</head>
<body>

<!-- Playgama initialization kept exactly where you put it -->
<script>
bridge.initialize()
    .then(() => {
        // Playgama initialized (kept here as requested)
        // Show splash for 4 seconds then start game
        showSplashThenStart();
    })
    .catch(error => {
        // If initialization fails we'll still attempt to start the game
        console.warn('Playgama init failed:', error);
        showSplashThenStart();
    });

/* Helper to show splash then call startGame */
function showSplashThenStart(){
  // splash element exists in DOM (created below). Ensure visible then wait 4s.
  const splash = document.getElementById('splash');
  if(splash) splash.style.display = 'flex';
  // wait 4 seconds then hide and start game
  setTimeout(async ()=>{
    if(splash) splash.style.display = 'none';
    try {
      await startGame();
    } catch(e){
      console.error('startGame error', e);
    }
  }, 4000);
}
</script>

<!-- Splash overlay: black background, your logo, "IQ Pro" white text -->
<div id="splash" style="display:none">
  <img src="https://connectgold.sbs/gold-2.png" alt="Connect Gold logo">
  <h2>IQ Pro</h2>
</div>

<div class="wrap">
  <div class="card" id="ui-card">
    <div class="row">
      <h1>IQ Pro</h1>
      <div class="spacer"></div>
      <div id="level" class="small">Level: 1</div>
      <div style="width:12px"></div>
      <div id="coins" class="small">Coins: 0</div>
    </div>

    <div id="meterWrap" style="margin-top:8px">
      <div class="meter"><i id="meterFill"></i></div>
    </div>

    <div id="timer" class="small">⏳ Time Left: 15s</div>

    <div id="question" aria-live="polite">Loading question...</div>

    <div class="answers" id="answers">
      <button class="btn" id="a">A</button>
      <button class="btn" id="b">B</button>
      <button class="btn" id="c">C</button>
      <button class="btn" id="d">D</button>
    </div>

    <div id="hint" class="small"></div>
    <div id="message"></div>

    <div id="controls">
      <button class="btn" id="skipBtn">Skip (10 coins)</button>
      <button class="btn" id="hintBtn">Reveal Hint (8 coins)</button>
      <button class="btn" id="watch-rewarded">Watch Ad → +20 coins</button>
      <button class="btn" id="daily-bonus">Daily +50</button>
    </div>

    <div id="lives" class="small">Lives: <span id="livesCount">3</span></div>

    <div id="game-over" class="card">
      <h2 id="go-title">Game Over</h2>
      <div id="go-info" class="small">You ran out of lives.</div>
      <div style="margin-top:12px">
        <button class="btn primary" id="restartBtn">Restart</button>
        <button class="btn" id="continueWithAd">Watch Ad to Continue (+1 life)</button>
      </div>
    </div>

    <div id="ad-container" style="margin-top:12px"></div>

    <div id="iap-buttons" style="margin-top:6px">
      <button class="btn" id="buy-50">Buy 50</button>
      <button class="btn" id="buy-100">Buy 100</button>
      <button class="btn" id="buy-200">Buy 200</button>
    </div>

  </div>

  <footer>
    <div class="small">Built with Playgama Bridge SDK • Test build</div>
  </footer>
</div>

<script>
/*
  All game logic is inside startGame() which runs only after:
   - Playgama SDK initialization (the place you requested), and
   - the 4-second splash has completed.
*/

async function startGame(){
  // ======= Game state =======
  const TOTAL_LEVELS = 200;
  let level = 1;
  let coins = 0;
  let lives = 3;
  let lastDailyBonus = null;
  let questions = [];
  let currentIndex = 0;
  let timeLeft = 15, timerId = null;
  let streak = 0;

  // UI elements (grab once)
  const levelEl = document.getElementById('level');
  const coinsEl = document.getElementById('coins');
  const questionEl = document.getElementById('question');
  const answersWrap = document.getElementById('answers');
  const ansButtons = Array.from(document.querySelectorAll('#a,#b,#c,#d'));
  const messageEl = document.getElementById('message');
  const timerEl = document.getElementById('timer');
  const skipBtn = document.getElementById('skipBtn');
  const hintBtn = document.getElementById('hintBtn');
  const watchRewardedBtn = document.getElementById('watch-rewarded');
  const dailyBtn = document.getElementById('daily-bonus');
  const livesCountEl = document.getElementById('livesCount');
  const gameOverPanel = document.getElementById('game-over');
  const restartBtn = document.getElementById('restartBtn');
  const continueWithAdBtn = document.getElementById('continueWithAd');
  const hintEl = document.getElementById('hint');
  const meterFill = document.getElementById('meterFill');

  // Helper UI
  function showMessage(text, t=1400){ messageEl.textContent = text; if(t) setTimeout(()=>{ if(messageEl.textContent===text) messageEl.textContent=''; }, t); }
  function updateUI(){ levelEl.textContent = `Level: ${level}`; coinsEl.textContent = `Coins: ${coins}`; livesCountEl.textContent = lives; meterFill.style.width = `${Math.min(100,(level/TOTAL_LEVELS)*100)}%`; }

  // ======= Questions (varied set) =======
  function createQuestions(){
    const pool = [];
    // Math questions (60)
    for(let i=1;i<=60;i++){
      const a = i;
      const b = Math.floor(Math.random()*10)+1;
      const correct = a + b;
      const opts = shuffle([correct, correct+1, correct-1, correct+2]).map(x=>String(x));
      pool.push({type:'math', q:`What is ${a} + ${b}?`, a:String(correct), options:opts, hint:`Think addition: ${a}+${b}`});
    }
    // General knowledge (10)
    const gk = [
      {q:'What planet do we live on?', a:'Earth', options:['Mars','Venus','Earth','Jupiter'], hint:'Home planet'},
      {q:'Which color do you get by mixing red and blue?', a:'Purple', options:['Green','Purple','Orange','Brown'], hint:'Red+Blue'},
      {q:'How many minutes in an hour?', a:'60', options:['30','45','60','90'], hint:'Think clock'},
      {q:'Which animal barks?', a:'Dog', options:['Cat','Cow','Dog','Sheep'], hint:'Common pet sound'},
      {q:'What do bees produce?', a:'Honey', options:['Milk','Honey','Silk','Wax'], hint:'Sweet and golden'},
      {q:'Which gas do plants take in?', a:'Carbon dioxide', options:['Oxygen','Nitrogen','Carbon dioxide','Helium'], hint:'Plants use it for photosynthesis'},
      {q:'How many months in a year?', a:'12', options:['10','11','12','13'], hint:'Calendar months'},
      {q:'Which shape has three sides?', a:'Triangle', options:['Square','Circle','Triangle','Pentagon'], hint:'Three sides'},
      {q:'What is H2O commonly called?', a:'Water', options:['Salt','Water','Sugar','Air'], hint:'Liquid we drink'},
      {q:'Which instrument has keys and makes music?', a:'Piano', options:['Guitar','Flute','Piano','Drum'], hint:'Large keyboard'}
    ];
    pool.push(...gk);

    // True/False (30)
    for(let i=0;i<30;i++){
      pool.push({type:'tf', q:`True or False: ${i%2===0? 'The sun rises in the east.':'Gold is a gas.'}`, a: i%2===0 ? 'True' : 'False', options:['True','False'], hint:'Think basic science'});
    }

    return shuffle(pool).slice(0, TOTAL_LEVELS);
  }

  // shuffle helper
  function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

  // Load persistent state
  async function loadState(){
    try{
      if(bridge && bridge.storage && typeof bridge.storage.get === 'function'){
        const saved = await bridge.storage.get(['level','coins','lives','lastDailyBonus']);
        if(saved){
          level = saved.level || 1;
          coins = saved.coins || 0;
          // saved.lives may be 0 (rare) — keep 3 as default if undefined
          lives = (typeof saved.lives === 'number') ? saved.lives : 3;
          lastDailyBonus = saved.lastDailyBonus || null;
        }
      }
    }catch(e){ console.warn('storage load', e); }
  }

  async function saveState(){
    try{
      if(bridge && bridge.storage && typeof bridge.storage.set === 'function'){
        await bridge.storage.set({level, coins, lives, lastDailyBonus});
      }
    } catch(e){ console.warn('storage save', e); }
  }

  // ======= Timer logic =======
  function startTimer(){
    clearInterval(timerId);
    timeLeft = 15;
    timerEl.textContent = `⏳ Time Left: ${timeLeft}s`;
    timerId = setInterval(()=>{
      timeLeft--;
      timerEl.textContent = `⏳ Time Left: ${timeLeft}s`;
      if(timeLeft<=0){
        clearInterval(timerId);
        onTimeout();
      }
    },1000);
  }
  function stopTimer(){ clearInterval(timerId); }

  // Handle timeout
  function onTimeout(){
    lives--;
    showMessage("⏰ Time's up! -1 life");
    if(lives<=0) { gameOver('out_of_lives'); return; }
    else {
      // step back one level (if above 1)
      if(level>1) level--;
      currentIndex = Math.max(0, level-1);
      updateUI();
      saveState();
      loadCurrentQuestion();
    }
  }

  // Ensure questions exist (fixes "Loading question..." when array empty)
  function ensureQuestionsReady() {
    if (!questions || questions.length === 0) {
      questions = createQuestions();
      currentIndex = Math.max(0, level - 1);
    }
  }

  // ======= Gameplay actions =======
  function loadCurrentQuestion(){
    hintEl.textContent = '';
    ensureQuestionsReady();
    const q = questions[currentIndex];
    if(!q){ questionEl.textContent = 'No question found'; return; }
    questionEl.textContent = q.q;
    // populate options (may be 2 or 4)
    const opts = Array.isArray(q.options) ? q.options.slice(0) : [];
    // ensure we have 4 placeholders
    const btns = ansButtons.slice(0,4);
    for(let i=0;i<4;i++){
      const btn = btns[i];
      if(opts[i]){
        btn.style.display = 'inline-block';
        btn.textContent = opts[i];
        btn.disabled = false;
        btn.dataset.correct = (opts[i]===q.a) ? '1' : '0';
      } else {
        btn.style.display = 'none';
        btn.textContent = '';
        btn.disabled = true;
        btn.dataset.correct = '0';
      }
    }
    startTimer();
  }

  function answerSelected(btn){
    stopTimer();
    const selected = btn.textContent;
    const q = questions[currentIndex];
    const correct = q.a;
    if(selected === correct){
      coins += 10;
      streak++;
      level = Math.min(TOTAL_LEVELS, level + 1);
      showMessage('✅ Correct! +10 coins');
      // interstitial every 5 levels
      if(level % 5 === 0) maybeShowInterstitial();
    } else {
      streak = 0;
      lives--;
      showMessage('❌ Wrong! -1 life');
      if(lives<=0){ gameOver('out_of_lives'); return; }
      // go back one level
      if(level>1) level--;
    }
    currentIndex = level - 1;
    updateUI();
    saveState();
    setTimeout(()=> loadCurrentQuestion(), 700);
  }

  // Skip / Hint
  skipBtn.addEventListener('click', ()=>{
    if(coins < 10){ showMessage('Need 10 coins to skip'); return; }
    coins -= 10;
    showMessage('Skipped (-10 coins)');
    level = Math.min(TOTAL_LEVELS, level + 1);
    currentIndex = level - 1;
    updateUI();
    saveState();
    loadCurrentQuestion();
  });

  hintBtn.addEventListener('click', ()=>{
    if(coins < 8){ showMessage('Need 8 coins for hint'); return; }
    coins -= 8;
    const q = questions[currentIndex];
    hintEl.textContent = q.hint || 'No hint available';
    showMessage('Hint revealed (-8 coins)');
    updateUI();
    saveState();
  });

  // Rewarded ad
  watchRewardedBtn.addEventListener('click', ()=>{
    if(bridge && bridge.advertisement && bridge.advertisement.isRewardedSupported){
      try { bridge.advertisement.showRewarded('rewarded_placement'); }
      catch(e){ showMessage('Ad failed to show'); console.warn(e); }
    } else {
      showMessage('Rewarded ad not supported');
    }
  });

  if(bridge && bridge.advertisement){
    bridge.advertisement.on(bridge.EVENT_NAME.REWARDED_STATE_CHANGED, state=>{
      if(state === 'rewarded'){
        coins += 20;
        showMessage('🎁 +20 coins from ad');
        updateUI();
        saveState();
      }
    });
  }

  // Daily bonus
  dailyBtn.addEventListener('click', async ()=>{
    const today = new Date().toDateString();
    if(lastDailyBonus === today){ showMessage('Daily already claimed'); return; }
    coins += 50; lastDailyBonus = today;
    showMessage('Daily +50 coins');
    updateUI();
    await saveState();
  });

  // Game Over and Continue with ad
  function gameOver(reason){
    stopTimer();
    gameOverPanel.style.display = 'block';
    if(reason==='out_of_lives') document.getElementById('go-info').textContent = 'You ran out of lives.';
    else document.getElementById('go-info').textContent = 'Game over';
  }

  restartBtn.addEventListener('click', ()=>{
    gameOverPanel.style.display = 'none';
    level = 1; coins = 0; lives = 3; currentIndex = 0; streak = 0;
    updateUI(); saveState();
    questions = createQuestions();
    loadCurrentQuestion();
  });

  continueWithAdBtn.addEventListener('click', ()=>{
    if(bridge && bridge.advertisement && bridge.advertisement.isRewardedSupported){
      bridge.advertisement.showRewarded('rewarded_continue');
    } else {
      showMessage('No ad available'); 
    }
  });

  if(bridge && bridge.advertisement){
    bridge.advertisement.on(bridge.EVENT_NAME.REWARDED_STATE_CHANGED, state=>{
      if(state === 'rewarded'){
        if(gameOverPanel.style.display === 'block'){
          lives = 1; gameOverPanel.style.display = 'none';
          showMessage('You continued! +1 life');
          updateUI(); saveState();
          loadCurrentQuestion();
        }
      }
    });
  }

  // Interstitial helper
  function maybeShowInterstitial(){
    if(bridge && bridge.advertisement && bridge.advertisement.isInterstitialSupported){
      try { bridge.advertisement.showInterstitial('interstitial_placement'); } catch(e){ console.warn(e); }
    }
  }

  // IAP handler (fallback simulation if bridge.iap not available)
  async function buyCoins(productId){
    if(bridge && bridge.iap && bridge.iap.isSupported){
      try {
        await bridge.iap.purchase(productId);
      } catch(e){ showMessage('Purchase failed'); console.warn(e); }
    } else {
      // fallback: simulate for testing
      if(productId === 'coins_50') coins += 50;
      if(productId === 'coins_100') coins += 100;
      if(productId === 'coins_200') coins += 200;
      showMessage('Purchase simulated (test): coins added');
      updateUI(); saveState();
    }
  }

  if(bridge && bridge.iap){
    bridge.iap.on(bridge.EVENT_NAME.PURCHASE_SUCCESS, async purchase=>{
      if(purchase.productId === 'coins_50') coins += 50;
      if(purchase.productId === 'coins_100') coins += 100;
      if(purchase.productId === 'coins_200') coins += 200;
      showMessage('Purchase successful');
      updateUI(); await saveState();
    });
  }

  document.getElementById('buy-50').addEventListener('click', ()=>buyCoins('coins_50'));
  document.getElementById('buy-100').addEventListener('click', ()=>buyCoins('coins_100'));
  document.getElementById('buy-200').addEventListener('click', ()=>buyCoins('coins_200'));

  // Wire up answer buttons
  ansButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      // disable all briefly to prevent double clicks
      ansButtons.forEach(b=>b.disabled=true);
      setTimeout(()=> ansButtons.forEach(b=>b.disabled=false), 700); // re-enable shortly
      answerSelected(btn);
    });
  });

  // Initialize game: load state, create questions and start
  await loadState();
  questions = createQuestions();
  currentIndex = Math.max(0, level - 1);
  updateUI();
  loadCurrentQuestion();

  // Banner if supported
  if(bridge && bridge.advertisement && bridge.advertisement.isBannerSupported){
    try{
      bridge.advertisement.showBanner('bottom','test_banner');
      bridge.advertisement.on(bridge.EVENT_NAME.BANNER_STATE_CHANGED, s=>console.log('banner',s));
    }catch(e){console.warn(e);}
  }

  // Periodic save
  setInterval(()=> saveState(), 15000);
} // end startGame()
</script>
</body>
</html>
